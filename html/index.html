<!DOCTYPE html>
<html>

<head>
  <title>Anonymous, volatile file sharing</title>
  <style>
    body {
        margin: 20px;
        color: #4297d7;
        font-family: Sans;
        background-image: url(/gradient-top.png);
        background-repeat: repeat-x;
    }

    #ads-box {
        float: right;
        border: dashed 2px #4297d7;
        width: 260px;
        height: 300px;
        text-align: center;
        padding-top: 300px;
        font-size: 20px;
    }

    #header {
        height: 100px;
    }

    #footer {
        margin-top: 20px;
        float: left;
        height: 40px;
        text-align: center;
        padding: 20px;
        width: 90%;
        font-size: 90%;
    }

    #logo {
        font-family: Sans;
        height: 50px;
        font-size: 46px;
        font-weight: bold;
        letter-spacing: -4px;
        color: #666;
    }

    #slogan {
        font-size: 17px;
        padding-left: 5px;
    }

    #content {
        float: left;
    }

  </style>

  <!-- JQuery UI -->
  <link type="text/css" href="/jquery-ui/css/start/jquery-ui-1.8.9.custom.css" rel="Stylesheet" />
  <script type="text/javascript" src="/jquery-ui/js/jquery-1.4.4.min.js"></script>
  <script type="text/javascript" src="/jquery-ui/js/jquery-ui-1.8.9.custom.min.js"></script>

  <!-- EventDance -->
  <script type="text/javascript" src="/transport/evdWebTransport.js"></script>
  <script type="text/javascript" src="/transport/evdJsonrpc.js"></script>


  <script type="text/javascript">

var transport = null;
var peer = null;
var lazyFiles = [];
var jsonRpc = null;

var fileSources = {};
var fileSourcesView;

window.addEventListener ("unload", stop, false);

function reLayout () {
    $ ("#content").css ("width", (document.documentElement.clientWidth - 330) + "px");
}

function getUrlRealm () {
    var tokens = window.location.toString().match(/\/\/[^\/]+\/(.*)(\/[^\/]+)+/);
    if (tokens && tokens.length > 0)
        return tokens[1];
    else
        return null;
}

$ (function () {
    $ ("#tabs").tabs ();
    $ ("#share-files-btn").button ();

    window.onresize = function (e) {
        reLayout ();
    };

    reLayout ();
    setupFileDropZone (document, onFilesDropped);

    fileSourcesView = new SharedFilesView ({
        parentElement: $ ("#shared-files-list").get(0)
    });

    fileSourcesView.addEventListener ("source-added",
        function () {
            $ ("#tabs").tabs('select', "#shared-files-tab");
        });
    fileSourcesView.addEventListener ("source-removed",
        function (ids) {
            jsonRpc.callMethod ("removeFileSources", [false, ids],
                function (result, error) {
                    if (error)
                        alert ("ERROR: " + error);
                });
        });
});

function stop () {
    if (peer)
        peer.close ();
}

function setupFileDropZone (element, callback) {
    var dropbox = element;

    dropbox.addEventListener ("dragenter", dragenter, false);
    dropbox.addEventListener ("dragover", dragover, false);
    dropbox.addEventListener ("drop", drop, false);

    function dragenter(e) {
        e.stopPropagation();
        e.preventDefault();
    }

    function dragover(e) {
        e.stopPropagation();
        e.preventDefault();
    }

    function drop(e) {
        e.stopPropagation();
        e.preventDefault();

        var dt = e.dataTransfer;
        var files = dt.files;

        callback (files);
    }
}

function setupTransport () {
    transport = new Evd.LongPolling ({url: "/transport"});
    transport.addEventListener ("new-peer", peerOnNew);
    transport.addEventListener ("receive", peerOnReceive);
    transport.open ();
}

function peerOnNew (_peer) {
    peer = _peer;
    jsonRpc = new Evd.Jsonrpc ({
        transportWriteCb: function (jsonRpc, data) {
            peer.sendText (data);
        },
        methodCallCb: function (methodName, params, invocationId) {
            if (methodName == "fileTransferNew") {
                if (newFileTransfer (params[0], params[1]))
                    jsonRpc.respond (invocationId, []);
                else
                    jsonrpc.respondError (invocationId, "Unknown file source");
            }
        }
    });

    while (lazyFiles.length > 0)
        onNewFileSources (lazyFiles.shift ());
}

function peerOnReceive (peer) {
    var data = peer.receiveText ();

    if (jsonRpc != null)
        jsonRpc.transportRead (data);
}

function onFilesDropped (files) {
    if (jsonRpc == null) {
        lazyFiles.push (files);

        if (transport == null)
            setupTransport ();
    }
    else
        onNewFileSources (files);
}

function onNewFileSources (files) {
    var params = [];
    for (var i=0; i<files.length; i++) {
        var file = files[i];
        params.push ([file.name, file.type, file.size]);
    }

    jsonRpc.callMethod ("addFileSources", params,
      function (result, error) {
          if (error == null) {
              addFileSources (files, result);
          }
          else {
              alert ("ERROR: " + error);
          }
      });
}

function addFileSources (files, ids) {
    for (var i = 0; i < ids.length; i++)
        if (ids[i] != null) {
            var id = ids[i];
            var file = files[i];

            fileSources[id] = file;

            var a = document.createElement ("A");
            a.href = "/file/" + id + "/download";

            fileSourcesView.add (id, file, a.href + "");
        }
}

function newFileTransfer (sourceId, transferId) {
    if (fileSources[sourceId] === undefined)
      return false;

    var file = fileSources[sourceId];
    uploadFile (file, "/file/" + transferId);

    return true;
}

function uploadFile (file, url) {
    var xhr = new XMLHttpRequest ();
    xhr.open ("PUT", url, true);
    xhr.onload = function () {
//        alert ("done");
    };
    xhr.send (file);
}

function filesAdded () {
    var files = $ ("#shared-files-selector").get(0).files;
    onFilesDropped (files);
}

  </script>
</head>

<body>
  <div id="header">
    <div id="logo">FileTea</div>
    <div id="slogan">Anonymous, volatile file sharing</div>
  </div>

  <div id="content">

  <div id="tabs">
    <ul>
      <li><a href="#shared-files-tab">Shared files</a></li>
      <li><a href="#tabs-2">Transfers</a></li>
      <li><a href="#tabs-3">Options</a></li>
      <li><a href="#tabs-4">Help</a></li>
    </ul>

    <div id="shared-files-tab">
      <link type="text/css" href="/shared-files-view.css" rel="Stylesheet" />
      <script type="text/javascript" src="/sharedFilesView.js"></script>

      <input type="file" multiple="true" id="shared-files-selector" onchange="filesAdded()"/>
      <button id="share-files-btn" onclick="$ ('#shared-files-selector').get(0).click()">Add files</button>
      <div id="shared-files-list"><div id="shared-files-list-empty-notice">
          <p class="title">No files shared!</p>
          <p class="comment">To share files use the 'Add files' button above or just drop them into the page</p>
        </div>
      </div>
    </div>
    <div id="tabs-2">
      <p>@TODO</p>
    </div>
    <div id="tabs-3">
      <p>@TODO</p>
    </div>
    <div id="tabs-4">
      <p>@TODO</p>
    </div>
  </div>

  </div>

  <div id="ads-box">advertise here</div>

  <div id="footer">
    <span>Copyright &copy; 2011</span>
    -
    <span>
      Powered by <a target="filetea_ext" href="http://blogs.free-social.net/elima/2010/10/14/eventdance-a-peer-to-peer-inter-process-communication-library/">EventDance</a>
    </span>
    <p>
      <a target="filetea_ext" href="http://en.wikipedia.org/wiki/HTML5"><img src="/html5_logo_32.png"/></a>
    </p>
  </div>

</body>
</html>
